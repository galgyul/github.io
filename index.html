<script>
    // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
    let db = null;
    let state = 'join';
    let roomId = '';
    let myId = null;
    let room = null;
    let roomRef = null;
    let timerInterval = null;

    // ë‹¨ì–´ ëª©ë¡
    const words = ['ì‚¬ê³¼','ë¹„í–‰ê¸°','í”¼ì•„ë…¸','í–„ë²„ê±°','ê°•ì•„ì§€','ìì „ê±°','ì»¤í”¼','ë‹¬','ì¶•êµ¬','ì±…','ì»´í“¨í„°','í…”ë ˆë¹„ì „','ëƒ‰ì¥ê³ ','ì„ í’ê¸°','ì—ì–´ì»¨','íœ´ëŒ€í°','í‚¤ë³´ë“œ','ë§ˆìš°ìŠ¤','ëª¨ë‹ˆí„°','í”„ë¦°í„°','ì˜ì','ì±…ìƒ','ì¹¨ëŒ€','ì†ŒíŒŒ','ì˜·ì¥','ê±°ìš¸','ì‹œê³„','ë¨í”„','ë² ê°œ','ì´ë¶ˆ','ì—°í•„','ì§€ìš°ê°œ','ê°€ìœ„','í’€','ì','ê³µì±…','í•„í†µ','ê°€ë°©','ìš°ì‚°','ì•ˆê²½','ì‹ ë°œ','ëª¨ì','ì¥ê°‘','ì–‘ë§','ë°”ì§€','ì…”ì¸ ','ì¹˜ë§ˆ','ì›í”¼ìŠ¤','ì½”íŠ¸','ìŠ¤ì¹´í”„','ì‚¬íƒ•','ì´ˆì½œë¦¿','ê³¼ì','ë¹µ','ì¼€ì´í¬','ì•„ì´ìŠ¤í¬ë¦¼','ìš°ìœ ','ì£¼ìŠ¤','ë¬¼','ì°¨','ê³ ì–‘ì´','í† ë¼','ìƒˆ','ë¬¼ê³ ê¸°','ê±°ë¶ì´','í–„ìŠ¤í„°','ë§','ì†Œ','ë¼ì§€','ë‹­','ì¥ë¯¸','íŠ¤ë¦½','í•´ë°”ë¼ê¸°','ë°±í•©','êµ­í™”','ë²šê½ƒ','ë¯¼ë“¤ë ˆ','ë‚˜ë¬´','í’€','ë‚˜ë­‡ì','ìë™ì°¨','ë²„ìŠ¤','ì§€í•˜ì² ','ê¸°ì°¨','ë°°','í—¬ë¦¬ì½¥í„°','ì˜¤í† ë°”ì´','í‚¥ë³´ë“œ','ìŠ¤ì¼€ì´íŠ¸ë³´ë“œ','ë¡¤ëŸ¬ìŠ¤ì¼€ì´íŠ¸','ì•¼êµ¬','ë†êµ¬','ë°°êµ¬','í…Œë‹ˆìŠ¤','íƒêµ¬','ê³¨í”„','ìˆ˜ì˜','ìŠ¤í‚¤','ìŠ¤ì¼€ì´íŠ¸','íƒœê¶Œë„'];

    const config = {
      apiKey: "AIzaSyBIudlMvRnm4GbMhmI7MPVxlHLup9Yq7Ak",
      authDomain: "coop-game-class.firebaseapp.com",
      databaseURL: "https://coop-game-class-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "coop-game-class",
      storageBucket: "coop-game-class.firebasestorage.app",
      messagingSenderId: "383356255700",
      appId: "1:383356255700:web:3d0d40bf45cd88af9f2a41"
    };

    // ì´ˆê¸°í™” ë° ì‹¤í–‰
    window.onload = function() {
      try {
        if (!firebase.apps.length) {
          firebase.initializeApp(config);
        }
        db = firebase.database();
        render(); 
      } catch (error) {
        console.error("Firebase Init Error:", error);
        document.getElementById('error-msg').innerText = "ì˜¤ë¥˜ ë°œìƒ: " + error.message;
        document.getElementById('error-msg').classList.remove('hidden');
        alert("ê²Œì„ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    };

    function render() {
      const appDiv = document.getElementById('app');
      if (!appDiv) return;

      // í¬ì»¤ìŠ¤ ìœ ì§€ ë¡œì§
      const activeEl = document.activeElement;
      const focusedId = activeEl ? activeEl.id : null;
      const selectionStart = activeEl ? activeEl.selectionStart : null;
      const selectionEnd = activeEl ? activeEl.selectionEnd : null;
      const currentInputValue = activeEl && activeEl.value ? activeEl.value : null;

      if (state === 'join') {
        appDiv.innerHTML = `
          <div class="flex items-center justify-center min-h-screen p-4">
            <div class="max-w-md w-full bg-white rounded-3xl shadow-2xl p-8 transform transition-all hover:scale-105">
              <h1 class="text-4xl font-extrabold text-center mb-8 text-indigo-600">í˜‘ë™ íŒíŠ¸ ê²Œì„</h1>
              <input type="text" id="nameInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" maxlength="10" class="w-full px-4 py-3 mb-4 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none transition-colors">
              <input type="text" id="roomInput" placeholder="ë°© ì½”ë“œ (ì°¸ê°€ ì‹œ)" maxlength="6" class="w-full px-4 py-3 mb-6 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none transition-colors uppercase">
              <div class="space-y-3">
                <button onclick="createRoom()" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 shadow-lg transition-transform active:scale-95">ìƒˆ ë°© ë§Œë“¤ê¸°</button>
                <button onclick="joinRoom()" class="w-full py-4 bg-white text-indigo-600 border-2 border-indigo-600 font-bold rounded-xl hover:bg-indigo-50 shadow-lg transition-transform active:scale-95">ë°© ì°¸ê°€í•˜ê¸°</button>
              </div>
            </div>
          </div>`;
      } else if (state === 'lobby') {
        const isHost = room.players && room.players[0] && room.players[0].id === myId;
        let html = `
          <div class="p-4 max-w-2xl mx-auto mt-10">
            <div class="bg-white rounded-3xl shadow-2xl p-8">
              <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">ëŒ€ê¸°ì‹¤</h1>
                <div class="bg-indigo-100 px-4 py-2 rounded-lg">
                  <span class="text-sm text-indigo-600 mr-2">ë°© ì½”ë“œ</span>
                  <span class="text-xl font-bold text-indigo-800 tracking-wider">${roomId}</span>
                </div>
              </div>
              
              <h2 class="text-lg font-semibold text-gray-600 mb-4">ì°¸ê°€ì (${room.players.length}/8)</h2>
              <div class="grid grid-cols-2 gap-3 mb-8">`;
                
        for (let i = 0; i < room.players.length; i++) {
          const p = room.players[i];
          html += `
            <div class="flex items-center gap-3 bg-gray-50 p-3 rounded-xl border border-gray-100">
              <div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold text-sm">
                ${p.name[0]}
              </div>
              <span class="font-medium text-gray-700 truncate">${p.name}</span>
              ${i === 0 ? '<span class="ml-auto text-xs bg-yellow-400 text-yellow-900 px-2 py-1 rounded-full font-bold">ë°©ì¥</span>' : ''}
              ${p.id === myId ? '<span class="ml-auto text-xs bg-green-500 text-white px-2 py-1 rounded-full font-bold">ë‚˜</span>' : ''}
            </div>`;
        }
        
        html += `</div>`;
        
        if (isHost) {
          html += `<button onclick="startGame()" ${room.players.length < 2 ? 'disabled' : ''} class="w-full py-4 bg-green-500 text-white text-xl font-bold rounded-xl hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed shadow-lg transition-all">ê²Œì„ ì‹œì‘</button>`;
        } else {
          html += `<div class="text-center p-4 bg-gray-50 rounded-xl text-gray-500 animate-pulse">ë°©ì¥ì´ ê²Œì„ì„ ì‹œì‘í•˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>`;
        }
        html += `</div></div>`;
        appDiv.innerHTML = html;

      } else if (state === 'waiting') {
        appDiv.innerHTML = `
          <div class="flex items-center justify-center min-h-screen">
            <div class="bg-white rounded-3xl shadow-2xl p-12 text-center transform scale-110 transition-transform">
              <h2 class="text-4xl font-extrabold mb-4 text-indigo-600">ê²Œì„ ì‹œì‘!</h2>
              <p class="text-2xl text-gray-600">ë¼ìš´ë“œ ${room.currentRound + 1} / 10</p>
            </div>
          </div>`;

      } else if (state === 'giving-hints') {
        const guesser = room.players[room.guesserIndex];
        const isGuesser = guesser.id === myId;
        const myHint = room.hints && room.hints[myId] ? room.hints[myId] : '';
        const submittedCount = room.hints ? Object.keys(room.hints).length : 0;
        const totalHinters = room.players.length - 1;
        
        let html = `
          <div class="p-4 max-w-4xl mx-auto mt-4">
            <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
              <div class="bg-indigo-600 p-6 text-white flex justify-between items-center">
                <h2 class="text-2xl font-bold">Round ${room.currentRound + 1}</h2>
                <div class="text-2xl font-mono font-bold ${room.timeLeft <= 5 ? 'text-red-300 animate-bounce' : ''}">â° ${room.timeLeft}ì´ˆ</div>
              </div>
              
              <div class="p-8">
                <div class="mb-8 p-6 bg-yellow-50 border-2 border-yellow-200 rounded-2xl text-center">
                  <p class="text-gray-600 font-medium mb-2">ì´ë²ˆì— ì •ë‹µì„ ë§í ì‚¬ëŒ</p>
                  <div class="text-3xl font-extrabold text-indigo-600">${guesser.name}</div>
                  ${isGuesser ? '<div class="mt-4 inline-block bg-red-100 text-red-600 px-4 py-2 rounded-lg font-bold animate-pulse">âš ï¸ í™”ë©´ì„ ë³´ì§€ ë§ˆì„¸ìš”!</div>' : ''}
                </div>`;
                
        if (!isGuesser) {
          html += `
            <div class="mb-8 text-center">
              <p class="text-sm text-gray-500 mb-2">ì„¤ëª…í•´ì•¼ í•  ë‹¨ì–´</p>
              <div class="inline-block px-12 py-6 bg-gradient-to-r from-purple-500 to-pink-500 rounded-2xl shadow-lg transform hover:scale-105 transition-transform">
                <span class="text-5xl font-extrabold text-white tracking-widest">${room.currentWord}</span>
              </div>
            </div>
            
            <div class="space-y-4">
              <label class="block text-lg font-bold text-gray-700">íŒíŠ¸ ì…ë ¥ (${submittedCount}/${totalHinters})</label>
              <div class="flex gap-2">
                <input type="text" id="hintInput" value="${myHint}" 
                  onkeydown="if(event.key==='Enter') handleHintInput(this.value)"
                  placeholder="ë‹¨ì–´ë¥¼ ì„¤ëª…í•˜ëŠ” íŒíŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                  maxlength="10" 
                  class="flex-1 px-6 py-4 text-lg border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none transition-colors">
                <button onclick="handleHintInput(document.getElementById('hintInput').value)" class="bg-indigo-600 text-white px-6 rounded-xl font-bold hover:bg-indigo-700">ì…ë ¥</button>
              </div>
              <p class="text-sm text-gray-500">* ì •ë‹µì´ í¬í•¨ëœ ë‹¨ì–´ëŠ” ì…ë ¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì—”í„°ë¡œ ì…ë ¥)</p>
              ${myHint ? '<p class="text-green-600 font-bold flex items-center">âœ“ íŒíŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</p>' : ''}
            </div>`;
        } else {
          html += `
            <div class="text-center py-12">
              <div class="text-6xl mb-6">ğŸ¤«</div>
              <h3 class="text-2xl font-bold text-gray-800 mb-2">ì¹œêµ¬ë“¤ì´ íŒíŠ¸ë¥¼ ì ê³  ìˆì–´ìš”</h3>
              <p class="text-gray-500">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
              <div class="mt-8 flex justify-center gap-2">
                ${Array(totalHinters).fill(0).map((_, i) => 
                  `<div class="w-3 h-3 rounded-full ${i < submittedCount ? 'bg-green-500' : 'bg-gray-200'}"></div>`
                ).join('')}
              </div>
            </div>`;
        }
        
        html += `</div></div></div>`;
        appDiv.innerHTML = html;

      } else if (state === 'guessing') {
        const guesser = room.players[room.guesserIndex];
        const isGuesser = guesser.id === myId;
        
        let html = `
          <div class="p-4 max-w-4xl mx-auto mt-4">
            <div class="bg-white rounded-3xl shadow-2xl p-8">
              <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Round ${room.currentRound + 1}</h2>
                <p class="text-xl"><span class="font-bold text-indigo-600 text-2xl">${guesser.name}</span>ë‹˜ì˜ ì¶”ë¦¬ ì‹œê°„!</p>
              </div>

              <div class="mb-8">
                <h3 class="text-lg font-bold text-gray-500 mb-4">ì¹œêµ¬ë“¤ì´ ì¤€ íŒíŠ¸</h3>
                <div class="flex flex-wrap justify-center gap-4">`;
                
        let hintCount = 0;
        for (let i = 0; i < room.players.length; i++) {
          const p = room.players[i];
          if (p.id !== guesser.id) {
            const hint = (room.hints && room.hints[p.id]) ? room.hints[p.id] : null;
            if (hint) {
              html += `
                <div class="bg-indigo-50 border-2 border-indigo-100 px-6 py-4 rounded-xl shadow-sm text-center min-w-[120px]">
                  <div class="text-xs text-indigo-400 mb-1">${p.name}</div>
                  <div class="text-xl font-bold text-indigo-900">${hint}</div>
                </div>`;
              hintCount++;
            }
          }
        }
        if (hintCount === 0) {
            html += `<div class="text-gray-400 italic">ì…ë ¥ëœ íŒíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤ ğŸ˜±</div>`;
        }
        
        html += `</div></div>`;
        
        if (isGuesser) {
          html += `
            <div class="mt-8 border-t pt-8">
              <label class="block text-lg font-bold mb-3 text-center">ì •ë‹µì€ ë¬´ì—‡ì¼ê¹Œìš”?</label>
              <div class="flex gap-2 max-w-lg mx-auto">
                <input type="text" id="guessInput" value="${room.guess || ''}" 
                  onkeydown="if(event.key==='Enter') submitGuess(this.value)"
                  placeholder="ì •ë‹µ ì…ë ¥" 
                  class="flex-1 px-6 py-4 text-xl border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none">
                <button onclick="submitGuess(document.getElementById('guessInput').value)" class="px-8 py-4 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 shadow-lg">ì œì¶œ</button>
              </div>
            </div>`;
        } else {
          html += `
            <div class="text-center mt-8 animate-pulse text-indigo-600 font-medium">
              ${guesser.name}ë‹˜ì´ ì •ë‹µì„ ì…ë ¥í•˜ê³  ìˆìŠµë‹ˆë‹¤...
            </div>`;
        }
        
        html += `</div></div>`;
        appDiv.innerHTML = html;

      } else if (state === 'result') {
        const isCorrect = room.guess === room.currentWord;
        appDiv.innerHTML = `
          <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-3xl shadow-2xl p-12 text-center max-w-lg w-full">
              <div class="text-8xl mb-6">${isCorrect ? 'ğŸ‰' : 'ğŸ’©'}</div>
              <h2 class="text-5xl font-extrabold mb-4 ${isCorrect ? 'text-green-600' : 'text-red-500'}">
                ${isCorrect ? 'ì •ë‹µì…ë‹ˆë‹¤!' : 'í‹€ë ¸ìŠµë‹ˆë‹¤!'}
              </h2>
              <div class="bg-gray-100 rounded-xl p-6 mb-6">
                <p class="text-sm text-gray-500 mb-2">ì •ë‹µ ë‹¨ì–´</p>
                <p class="text-4xl font-bold text-gray-800">${room.currentWord}</p>
                ${!isCorrect ? `<p class="text-xl text-gray-500 mt-2 strike-through">ì…ë ¥í•œ ë‹µ: ${room.guess}</p>` : ''}
              </div>
              <p class="text-xl font-bold text-indigo-600">í˜„ì¬ ì ìˆ˜: ${room.score}ì </p>
            </div>
          </div>`;

      } else if (state === 'final') {
        const s = room.score;
        let medal = 'ğŸ’ª', text = 'ì¡°ê¸ˆ ë” ë…¸ë ¥í•´ë´ìš”!';
        if (s === 10) { medal = 'ğŸ†'; text = 'ì „ì„¤ì ì¸ íŒ€ì›Œí¬!'; }
        else if (s >= 8) { medal = 'ğŸ¥‡'; text = 'í™˜ìƒì˜ íŒ€ì›Œí¬!'; }
        else if (s >= 5) { medal = 'ğŸ¥ˆ'; text = 'ì¢‹ì€ íŒ€ì›Œí¬!'; }
        else if (s >= 3) { medal = 'ğŸ¥‰'; text = 'ê°€ëŠ¥ì„±ì´ ë³´ì—¬ìš”!'; }
        
        const isHost = room.players[0].id === myId;
        const playerNames = room.players.map(p => p.name).join(', ');
        
        let html = `
          <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-3xl shadow-2xl p-10 text-center max-w-2xl w-full">
              <div class="text-9xl mb-6 bounce">${medal}</div>
              <h2 class="text-4xl font-bold mb-2 text-gray-800">${text}</h2>
              <div class="my-8 p-6 bg-indigo-50 rounded-2xl">
                <div class="text-sm text-indigo-500 font-bold uppercase tracking-wider mb-2">Final Score</div>
                <div class="text-6xl font-black text-indigo-600">${room.score} / 10</div>
              </div>
              <p class="text-gray-600 mb-8 px-8">í•¨ê»˜í•œ ì¹œêµ¬ë“¤:<br><strong>${playerNames}</strong></p>
              
              ${isHost ? 
                `<button onclick="resetGame()" class="w-full py-4 bg-indigo-600 text-white text-xl font-bold rounded-xl hover:bg-indigo-700 shadow-lg transform transition hover:-translate-y-1">ğŸ”„ ë‹¤ì‹œ ì‹œì‘í•˜ê¸°</button>` : 
                `<p class="text-gray-400 animate-pulse">ë°©ì¥ì´ ì¬ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥¼ ë•Œê¹Œì§€ ëŒ€ê¸°ì¤‘...</p>`
              }
            </div>
          </div>`;
        appDiv.innerHTML = html;
      }

      if (focusedId) {
        const el = document.getElementById(focusedId);
        if (el) {
          if (currentInputValue !== null) el.value = currentInputValue;
          el.focus();
          if (selectionStart !== null && selectionEnd !== null) {
            el.setSelectionRange(selectionStart, selectionEnd);
          }
        }
      }
    }

    function createRoom() {
      const name = document.getElementById('nameInput').value.trim();
      if (!name) return alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      
      roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
      myId = Date.now().toString();
      
      const newRoom = {
        id: roomId,
        players: [{ id: myId, name: name }],
        gameState: 'lobby',
        currentRound: 0,
        score: 0,
        guesserIndex: 0,
        hints: {},
        guess: '',
        timeLeft: 60,
        currentWord: '',
        selectedWords: []
      };
      
      db.ref('rooms/' + roomId).set(newRoom).then(() => {
        setupRoomListener();
      });
    }

    function joinRoom() {
      const name = document.getElementById('nameInput').value.trim();
      const code = document.getElementById('roomInput').value.trim().toUpperCase();
      if (!name || !code) return alert('ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      
      db.ref('rooms/' + code).once('value').then(snap => {
        const data = snap.val();
        if (!data) { alert('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤.'); return; }
        if (data.players.length >= 8) { alert('ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.'); return; }
        if (data.gameState !== 'lobby') { alert('ì´ë¯¸ ê²Œì„ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.'); return; }
        
        roomId = code;
        myId = Date.now().toString();
        
        const updatedPlayers = data.players.concat([{ id: myId, name: name }]);
        db.ref('rooms/' + roomId + '/players').set(updatedPlayers).then(() => {
          setupRoomListener();
        });
      });
    }

    function setupRoomListener() {
      roomRef = db.ref('rooms/' + roomId);
      roomRef.on('value', snap => {
        room = snap.val();
        if (room) {
          state = room.gameState;
          render();
          
          if (room.players && room.players[0].id === myId) {
             manageTimerHost(); // íƒ€ì´ë¨¸ ê´€ë¦¬
             checkAutoSkipHost(); // [ì¶”ê°€ë¨] íŒíŠ¸/ì •ë‹µ ìë™ ë„˜ê¹€ í™•ì¸
          }
        } else {
           alert('ë°© ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.');
           location.reload();
        }
      });
    }

    // [ì¶”ê°€ëœ í•¨ìˆ˜] ë°©ì¥ì´ ëª¨ë“  ì‚¬ëŒì´ íŒíŠ¸ë¥¼ ëƒˆëŠ”ì§€ í™•ì¸
    function checkAutoSkipHost() {
      if (!room) return;

      // íŒíŠ¸ ë‹¨ê³„ì¼ ë•Œ
      if (state === 'giving-hints') {
        const totalPlayers = room.players.length;
        const requiredHints = totalPlayers - 1; // ì •ë‹µ ë§íˆëŠ” ì‚¬ëŒ ì œì™¸
        const currentHints = room.hints ? Object.keys(room.hints).length : 0;

        // ëª¨ë“  íŒíŠ¸ê°€ ë“¤ì–´ì™”ë‹¤ë©´ ë°”ë¡œ guessing ë‹¨ê³„ë¡œ ì´ë™
        if (currentHints >= requiredHints) {
          db.ref('rooms/' + roomId).update({ gameState: 'guessing' });
        }
      }
    }

    function manageTimerHost() {
      if (state === 'giving-hints') {
        if (!timerInterval) {
           timerInterval = setInterval(() => {
             if (!room || room.gameState !== 'giving-hints') {
               clearInterval(timerInterval);
               timerInterval = null;
               return;
             }
             
             if (room.timeLeft > 0) {
               db.ref('rooms/' + roomId + '/timeLeft').set(room.timeLeft - 1);
             } else {
               clearInterval(timerInterval);
               timerInterval = null;
               db.ref('rooms/' + roomId).update({ gameState: 'guessing' });
             }
           }, 1000);
        }
      } else {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }
    }

    function startGame() {
      if (!room || room.players.length < 2) return alert('ìµœì†Œ 2ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      
      const shuffled = words.slice().sort(() => Math.random() - 0.5);
      const selectedWords = shuffled.slice(0, 10);
      
      db.ref('rooms/' + roomId).update({
        gameState: 'waiting',
        selectedWords: selectedWords,
        currentRound: 0,
        score: 0
      });
      
      setTimeout(() => startRound(), 2000);
    }

    function startRound() {
      const guesserIndex = room.currentRound % room.players.length;
      db.ref('rooms/' + roomId).update({
        gameState: 'giving-hints',
        guesserIndex: guesserIndex,
        currentWord: room.selectedWords[room.currentRound],
        hints: {},
        guess: '',
        timeLeft: 60
      });
    }

    function handleHintInput(val) {
        if (!val.trim()) return;
        if (val.includes(room.currentWord)) {
            alert("ì •ë‹µ ë‹¨ì–´ê°€ í¬í•¨ë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
            return;
        }
        db.ref('rooms/' + roomId + '/hints/' + myId).set(val.trim());
    }

    function submitGuess(val) {
      if (!val || !val.trim()) return;
      
      db.ref('rooms/' + roomId + '/guess').set(val.trim());

      const isCorrect = val.trim() === room.currentWord;
      db.ref('rooms/' + roomId).update({
        score: isCorrect ? room.score + 1 : room.score,
        gameState: 'result'
      });
      
      setTimeout(() => {
        if (room.currentRound + 1 < 10) {
          db.ref('rooms/' + roomId + '/currentRound').set(room.currentRound + 1);
          setTimeout(() => startRound(), 500);
        } else {
          db.ref('rooms/' + roomId + '/gameState').set('final');
        }
      }, 3000);
    }

    function resetGame() {
      db.ref('rooms/' + roomId).update({
        gameState: 'lobby',
        currentRound: 0,
        score: 0,
        hints: {},
        guess: '',
        selectedWords: []
      });
    }
  </script>